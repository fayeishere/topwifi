<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Grade City</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <link href='http://fonts.googleapis.com/css?family=Press+Start+2P' rel='stylesheet' type='text/css'>

        <link rel="stylesheet" href="css/normalize.min.css">
        <link rel="stylesheet" href="css/nyc.css">
        <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
        <style type="text/css">
            #results {
                display: none;
            }
            .red{
                color: red;
            }
            .field{
                width: 400px;
            }
        </style>
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->





        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.min.js"><\/script>')</script>

        <script src="js/main.js"></script>
        <script type="text/javascript">
            function ListingsArray(){
                var city_names = document.getElementById('city-batch').value;
                cities_split = city_names.split(/\*+/);
                for (var i = 0; i < cities_split.length; i++) {
                    var city_name = cities_split[i];
                    Listings(city_name);
                }
            }
            function SingleListing(){
                var city_name = document.getElementById('city-name').value;
                Listings(city_name);
            }
            function Listings(city_name){
                var num_listings = document.getElementById('listings-num').value;
                var ga_sessions = document.getElementById('ga-sessions').value;
                var category;
                var misbehaving;
                var points = 0;
                var population = "not enough data yet";
                var added_from_sheet = false;

                if(num_listings == "" || ga_sessions == ""){
                    console.log('not a manual entry');
                    added_from_sheet = true;
                    var remove_commas = city_name.replace(/,/g, "");
                    var string_it = remove_commas.match(/[0-9]+/g);
                    var starbucks = city_name.match(/Star(\d+)/);
                    var remote_city = city_name.match(/#(\d+)/);
                    if(starbucks){
                        points += 5;
                    }
                    if(remote_city){
                        points += 4;
                    }

                    var from_sheet = city_name.replace(/[0-9]/g, '');
                    var trimmed_from_sheet = from_sheet.trim();
                    city_name = trimmed_from_sheet.split(/\s+/)[0];
                    num_listings = string_it[1];
                    ga_sessions = string_it[10];
                    if(string_it[17]){
                        population = string_it[17];
                    }
                    get_points();
                }
                sessions();

                function get_points(){
                    if(population >= 4000000){
                        points += 5;
                    }
                    else if(population >= 1000000){
                        points +=4;
                    }
                    else if(population >= 800000){
                        points +=3;
                    }
                    else if(population >= 500000){
                        points +=2;
                    }
                    else if(population >= 300000){
                        points +=1;
                    }
                    else if(population >= 0) {
                        console.log("low populated city");
                    }
                    else{
                        console.log(population);
                    }
                    console.log(points);
                }

                function sessions(){
                    if(ga_sessions >= 500){
                        category = "winning";
                        results(category);
                    }
                    else if(ga_sessions >= 150){
                        category = "very good";
                        results(category);
                    }
                    else if(ga_sessions >= 115){
                        category = "pretty good";
                        results(category);
                    }
                    else if(ga_sessions >= 70){
                        category = "okay";
                        results(category);
                    }
                    else if(ga_sessions >= 50){
                        category = "less than okay";
                        results(category);
                    }
                    else{
                        category = "dead or NA";
                        results(category);
                    }
                }


                function results(category){
                    if (num_listings >= 50 && ga_sessions <= 500){
                        misbehaving = true;
                    }
                    else if (num_listings >= 35 && ga_sessions <= 150){
                        misbehaving = true;
                    }
                    else if (num_listings >= 20 && ga_sessions <= 115){
                        misbehaving = true;
                    }
                    else if (num_listings >= 10 && ga_sessions <= 70){
                        misbehaving = true;
                    }
                    else if (num_listings >= 5 && ga_sessions <= 50){
                        misbehaving = true;
                    }
                    else{
                        misbehaving = false;
                    }
                    $( "#results" ).append( "<p>City name: <b>" + city_name + "</b></p><p>Category: <b>" + category + "</b></p><p>Misbehaving? " + misbehaving + "</p>");

                    if(added_from_sheet){
                        console.log('action!');
                        // ad or email or neither?
                        var intercom_users = string_it[4];
                        var return_users_percent = string_it[15];
                        if(intercom_users >= 15 && num_listings >= 20 && points >= 2){
                            if(misbehaving === true || return_users_percent < 25){
                                $( "#results" ).append( "<p>Marketing Recommendation: <b class='red'>Email Campaign and Ad Campaign</b></p></br>");
                            }
                            else{
                                $( "#results" ).append( "<p>Marketing Recommendation: <b>Nothing right now. Low priority</b></p></br>");
                            }
                        }
                        else if(intercom_users >= 15){
                            if(misbehaving === true || return_users_percent < 25){
                                $( "#results" ).append( "<p>Marketing Recommendation: <b class='red'>Email Campaign</b></p></br>");
                            }
                            else{
                                $( "#results" ).append( "<p>Marketing Recommendation: <b>Nothing right now. Low priority</b></p></br>");
                            }
                        }
                        else if(num_listings >= 20 && points >= 2){
                            $( "#results" ).append( "<p>Marketing Recommendation: <b class='red'>Targeted Ad Campaign</b></p></br>");
                        }
                        else{
                            $( "#results" ).append( "<p>Marketing Recommendation: <b>Nothing right now. Low priority</b></p></br>");
                        }
                    }
                    document.getElementById('city-name').value = "";
                    $( "#results" ).show();
                }
            }




        </script>
            <div class="main-container">
<!--             <div class="main wrapper clearfix"> -->


            <form name="city_stats">
              <input type="text" name="city" id="city-name" class="field" placeholder="city name or c/p entire single city row from sheet" />
              <input type="text" id="listings-num" class="field" name="listings" placeholder="number of listings is only for manual entry only"/>
              <input type="text" id="ga-sessions" class="field" name="sessions" placeholder="GA sessions last 30 days only for manual entry only"/>
              <br>
              <input id="submit" type="button" name="submit" onclick="SingleListing()" value="Submit" />
            </form>
            <br>
            <form name="city_stats_batch">
              <input type="text" name="cities" id="city-batch" class="field" style="height:300px;" placeholder="batch of cities from sheet" />
              <input type="button" name="submit" onclick="ListingsArray()" value="Submit" />
            </form>
            <div id="results"></div>
        </div> <!-- #main-container -->
    </body>
</html>
